= Practical 3: Linking VMS and logbook data and explore the benefits =

== Introduction ==
You have already come a long way by importing your VMS and logbook data, cleaning your datasets to ensure that whatever analyses you want to carry out, the basis is solid. We can't stress it enough, as with normal statistics, getting your data ready and in the right format is crucial for your results. 

The potential of having these two datasets combined is large and discussed in the presentation already. Here we will show how it's done and how to make some first pictures out of it. You might be disappointed however when you see how much work it takes :-).

== Getting the data ready ==
If you still have an R version running with the results of the cleaning step, use those eflalo and tacsat results. If you had to start R anew, don't worry, we will show you how it works, and with your own data you can do it properly in one go (but note that you should only start to link VMS and logbook data after the cleaning process!).

== Linking VMS and logbook data ==
<code>
>tacsatp <- mergeEflalo2Tacsat(eflalo,tacsat)
>head(tacsatp)
         VE_COU VE_REF  SI_LATI  SI_LONG    SI_DATE  SI_TIME SI_SP SI_HE            SI_DATIM INTV FT_REF
662894 Atlantis     10 51.67319 3.176576 05/05/1800  4:54:00     2    43 1800-05-05 04:54:00  116 272058
662895 Atlantis     10 51.69432 3.229084 05/05/1800  6:48:00     2   294 1800-05-05 06:48:00  114 272058
662896 Atlantis     10 51.65607 3.160989 05/05/1800  8:44:00     6   144 1800-05-05 08:44:00  116 272058
662897 Atlantis     10 51.60704 3.083506 05/05/1800 10:40:00     7   248 1800-05-05 10:40:00  116 272058
662898 Atlantis     10 51.57692 2.987796 05/05/1800 14:30:00     6   228 1800-05-05 14:30:00  230 272058
662899 Atlantis     10 51.54655 2.876395 05/05/1800 16:24:00     7    50 1800-05-05 16:24:00  114 272058

>print(length(which(tacsatp$FT_REF == 0))) #number of records not able to link
</code>
What we can observe is that another column is added to the 'tacsatp' object, namely the 'FT_REF' column. What happened 'under the hood' is the linking of VMS and logbook based on vessel name+year and time stamps, such that each VMS record would fall within the time frame of departure and arrival of a logbook record of that same vessel. Now we know which VMS record can be associated with which eflalo record. This allows for some cool things to explore. Note that if no linking was possible, FT_REF will equal "0".
<code>
#Move the gear type from eflalo to tacsat
>tacsatp$LE_GEAR <- eflalo$LE_GEAR[match(tacsatp$FT_REF,eflalo$FT_REF)]

#Let's see if it worked correctly
>subset(tacsatp,FT_REF == "326494")
         VE_COU VE_REF  SI_LATI  SI_LONG    SI_DATE  SI_TIME SI_SP SI_HE            SI_DATIM INTV FT_REF LE_GEAR
1019702 Atlantis    102 51.63328 3.480378 20/12/1801  7:16:00   0.6   354 1801-12-20 07:16:00  114 326494     DRB
1019703 Atlantis    102 51.64547 3.462132 20/12/1801  9:12:00   0.0   258 1801-12-20 09:12:00  116 326494     DRB
1019704 Atlantis    102 51.63715 3.447098 20/12/1801 11:06:00   0.0   280 1801-12-20 11:06:00  114 326494     DRB
1019705 Atlantis    102 51.63734 3.451090 20/12/1801 13:02:00   0.2    86 1801-12-20 13:02:00  116 326494     DRB
1019706 Atlantis    102 51.63760 3.458493 20/12/1801 14:58:00   0.6   132 1801-12-20 14:58:00  116 326494     DRB
1019707 Atlantis    102 51.64877 3.528120 20/12/1801 16:52:00   6.8    72 1801-12-20 16:52:00  114 326494     DRB

>subset(eflalo,FT_REF == "326494")
      VE_REF VE_FLT   VE_COU VE_LEN VE_KW VE_TON FT_REF FT_DCOU FT_DHAR    FT_DDAT FT_DTIME FT_LCOU FT_LHAR    FT_LDAT FT_LTIME
48267    102    DRB Atlantis     29   127     NA 326494     nld      NL 20/12/1801 06:00:00     nld      NL 20/12/1801 18:00:00
</code>

=== Exercise 1 ===
  # Check if in the example above the merging went well. How do you check?
  # What types of gears are available in the VMS dataset, how many of each?

== Explore the benefits ==
Similar to the presentation, we will quickly look into four types of benefit
  # Distinguish fishery types
  # Define activity
  # Fine scale effort patterns
  # Distribution of catches / values

=== Distinguish fishery types ===
Most often, fishery type is determined by the gear used when fishing. As we have already assigned gear type from eflalo to tacsat, splitting the tacsat data up into bits per gear type is not too difficult.
<code>
>TBB <- subset(tacsatp,LE_GEAR == "TBB")
>OTB <- subset(tacsatp,LE_GEAR == "OTB")

#Let's see what speed profiles are associated with these fishery types
>par(mfrow=c(2,1))
>hist(TBB$SI_SP,breaks=100,xlim=c(0,20),xlab="Knots",main="TBB")
>hist(OTB$SI_SP,breaks=100,xlim=c(0,20),xlab="Knots",main="OTB")
</code>
Do not close this picture immediately, it comes in handy in the next example. 

=== Define activity ===
In many cases, activity can be defined based on speed. We've just made a picture of the speed profiles. Can you distinguish different behavior looking at these plots already? In general, there are 3 types of behavior to be distinguished (but with more information on the fishery, you could potentially indicate even more behaviors). 
  # Floating / being in harbour, associated with very low to zero speeds. 
  # Fishing, associated with intermediate speeds. 
  # Steaming, associated with high speeds. If we now look back at the figure we just made, in the OTB panel, we can observe 2 'hills', one with mean around 3knots ranging between 2 and 6/7 knots and one with a mean around 10knots ranging between 7 and 13knots. Everything below 1knot can be assigned to 'floating / being in harbour. All in all, this is a simple approach, but might be very time consuming. 

Therefore, based on these ideas, different functionalities have been developed. 
  # segmentTacsatSpeed, segmented regression on speed profile and automatic detection of fishing versus no-fishing
  # activityTacsat, normal density curve fitting based on speed profile but informed by user decision

I will present short examples of both methods.

==== SegmentTacsatSpeed ====
Note that you can only run this example with 1 year of data!
<code>
>tacsatp$idx       <- 1:nrow(tacsatp)
>tacsatp$LE_GEAR   <- af(tacsatp$LE_GEAR) #this needs to be a factor for the calculation that follows
>tmpPath          <- "D:/output/" #specify a temporary folder for output
>tacsatSegment     <- segmentTacsatSpeed(tacsatp[which(is.na(tacsatp$LE_GEAR)==F),],general=list(output.path=tmpPath,visual.check=F, a.year=c(1800)))
>tacsatp           <- merge(tacsatp,tacsatSegment[,c("idx","SI_STATE")],by=c("idx"),all.x=T)

#Lets look at the results, left = no-fishing, right = fishing
>spds <- table(tacsatp$SI_SP,tacsatp$SI_STATE)
>barplot(spds,names.arg=rep(dimnames(spds)[[1]],2),beside=T)
</code>
==== activityTacsat ====
This functionality works on more than 1 year and can be used to define activity of all similar gears or on a vessel level. In its most sophisticated form, it requires input from the user to determine peaks of fishing and no-fishing which will eventually result in better results. 
<code>
>tacsatp$LE_GEAR[which(is.na(tacsatp$LE_GEAR)==T)] <- "NO_GEAR"
>tacsatp$LE_GEAR <- ac(tacsatp$LE_GEAR)

#Analyse a selection of the data, a window will pop-up!
>storeScheme   <- activityTacsatAnalyse(subset(tacsatp,LE_GEAR == "OTM" & year(SI_DATIM) == 1801),units="year",analyse.by="LE_GEAR")
>require(mixtools)
#After analysing the peaks, time to let the magic fit normal density distributions to the data
>res           <- activityTacsat(subset(tacsatp,LE_GEAR == "OTM" &
                      year(SI_DATIM) == 1801),units="year",analyse.by="LE_GEAR",storeScheme)
#Make sure the same selection is used when writing the results to the original tacsat dataset
>tacsatSubset <- subset(tacsatp,LE_GEAR == "OTM" & year(SI_DATIM) == 1801 & is.na(SI_SP)==F)
>tacsatSubset$SI_STATE <- res

#Lets look at the results
>spds <- table(tacsatSubset$SI_SP,tacsatSubset$SI_STATE)
>plot(y=spds[,1],x=an(dimnames(spds)[[1]]),type="h",ylim=range(spds),xlab="knots",ylab="Frequency")
>lines(y=spds[,2],x=(an(dimnames(spds)[[1]])+0.1),col=2,type="h")
>lines(y=spds[,3],x=(an(dimnames(spds)[[1]])+0.2),col=3,type="h")
>legend("topright",legend=c("No fishing","Fishing","Steaming"),col=1:3,box.lty=0,lwd=2,lty=1)
</code>
From both these examples you can tell already that it isn't easy to determine activity and it will most certainly take you a considerate amount of time to do this properly. However, it is very important as the results of this analyses are most often used as input to follow-up analyses!

=== Fine scale effort patterns ===
With the gear type available in tacsat, I can now compare the effort available in the VMS data and compare that with the effort data in the logbooks. Therefore however, I need to calculate the effort of the VMS data. 
<code>
>tacsatp <- sortTacsat(tacsatp) #Make sure it is ordered correctly
>tacsatp <- effort(tacsatp, level = "trip", unit = "hours",fill.na=T)
>eflalop <- effort(eflalo,level="trip",unit="hours",fill.na=T)
>eflalop$LE_EFF_LOG <- an(eflalop$LE_EFF_LOG)

#Let's quickly introduce a plotting routine, you'll hear more about that later on in the course
>require(RColorBrewer)
#First the tacsat effort
>plotTools(subset(tacsatp,LE_GEAR == "OTM" & year(SI_DATIM) == 1801),level="gridcell",xlim=c(-5,10),ylim=c(48,62),zlim=NULL,log=F,gridcell=c(0.1,0.05),color=NULL,control.tacsat=list(clm="LE_EFF_VMS"))
#Now the eflalo effort
>x11()
>plotTools(subset(eflalop,LE_GEAR == "OTM" & year(SI_DATIM) == 1801),level="ICESrectangle",xlim=c(-5,10),ylim=c(48,62),zlim=NULL,log=F,color=NULL,control.eflalo=list(clm="LE_EFF_LOG"))
</code>
Quite a difference, not! Having VMS and logbook data available allows you to dispatch catches, values or effort at a much finer scale. If this is as good and believable as normal logbook data is up to you, the tools are there however.

=== Distribution of catches / values ===
Similar to the analyses above, we can make a picture of for example plaice landings on the spatial scale of VMS. Note here however that we are about to dispatch landings at a much finer spatial scale that is not stored in the data and is a complete interpretation of the data available. It is up to you to decide if this is a wise analyses to perform!
<code>
>tacsatEflalo      <- splitAmongPings(tacsat=subset(tacsatp,LE_GEAR == "TBB" & year(SI_DATIM)==1801),eflalo=subset(eflalo,LE_GEAR == "TBB"),
                        variable="all",level="day",conserve=T)

#Lets make some plots again
>plotTools(tacsatEflalo,level="gridcell",xlim=c(-5,10),ylim=c(48,62),zlim=NULL,log=F,gridcell=c(0.1,0.05),color=NULL,control.tacsat=list(clm="LE_KG_PLE"))
>eflalo$FT_DDATIM <- as.POSIXct(paste(eflalo$FT_DDAT,eflalo$FT_DTIME),format="%d/%m/%Y %H:%M")
>x11()
>plotTools(subset(eflalo,LE_GEAR == "TBB" & year(FT_DDATIM) == 1801),level="ICESrectangle",xlim=c(-5,10),ylim=c(48,62),zlim=NULL,log=F,color=NULL,control.eflalo=list(clm="LE_KG_PLE"))